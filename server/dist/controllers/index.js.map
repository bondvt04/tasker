{"version":3,"sources":["controllers/index.js"],"names":[],"mappings":"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","file":"controllers/index.js","sourcesContent":["var Node = require(\"../models/Node\");\nvar Promise = require(\"promise\");\n//var querystring = require(\"querystring\");\n\nclass Controller {\n\n    __beforeAction(req, res, next) {\n        // we will render it later if no error\n        res.jsonToRender = {};\n    }\n\n    __afterAction(req, res, next, result) {\n        //return new Promise(function(resolve, reject) {\n        //    console.log(\"### 3\");\n        //    resolve(result);\n        //    //next();\n        //});\n    }\n\n    /**\n     * Args: [req, res, next]\n     */\n    doAction(actionName, args) {\n        var functionName = \"_\"+actionName+\"Action\";\n        var self = this;\n        var req = args[0];\n        var res = args[1];\n        var next = args[2];\n\n        return new Promise(function(resolve, reject) {\n            if(self[functionName] && \"function\" === typeof self[functionName]) {\n                self.__beforeAction(req, res, next);\n\n                // fill with arguments as is (not as array)\n                var actionPromise = self[functionName](...Array.prototype.slice.call(args));\n\n                function doAfterAction() {\n                    process.on('uncaughtException', function (err) {\n                        console.log(\"lol error\");\n                        console.error(err);\n                    });\n\n                    //try {\n                        console.log(\"---^^^---1\");\n                        throw new Error(\"zlo\");\n                        console.log(\"---^^^---2\");\n                        var afterActionPromise = self.__afterAction(req, res, next, result);\n\n                        console.log(\"---&&&---\");\n\n                        afterActionPromise.then(function(result) {\n                            console.log(\"### 4\");\n                            resolve(result);\n                        }).catch(function(err) {\n                            console.log(\"### 5\");\n                            reject(err);\n                        }).done(function() {\n                            console.log(\"### 6\");\n                        });\n                    //} catch(e) {\n                        //console.log(e);\n                        //console.error(e);\n                        //throw e;\n                    //}\n                }\n\n                actionPromise.then(function(result) {\n                    console.log(\"### 7\");\n                    doAfterAction().then(function(afterActionResult) {\n                        resolve(afterActionResult);\n                    }).catch(function(err) {\n                        reject(err);\n                    });\n                }).catch(function(err) {\n                    console.log(\"### 8\");\n                    doAfterAction();\n                    reject(err);\n                });\n            }\n        });\n    }\n\n    /**\n     * Тестим ловлю ошибок\n     */\n    _error500Action(req, res) {\n        return new Promise(function(resolve, reject) {\n            try {\n                console.log(\"_error500Action\");\n                lol.hello.ololo();\n                throw new Error(\"zlo\");\n            } catch(e) {\n                console.log(\"### 1\");\n                reject(e);\n            }\n        });\n    }\n\n    /**\n     * @todo Add filter, tags etc logic\n     * @todo do res.end() in the end, not in controller\n     */\n    _getNodesAction(req, res) {\n        return new Promise(function(resolve, reject) {\n            Node.find(function (err, nodes) {\n                if (err) reject(err);\n\n                res.send(nodes);\n\n                resolve(nodes);\n            });\n\n            //Kitten.find({ name: /^Fluff/ }, callback);\n        });\n    }\n\n    _addNodeAction(req, res) {\n        var newNode = new Node(req.body);\n\n        return new Promise(function(resolve, reject) {\n            newNode.save(function (err, node) {\n                if (err) reject(err);\n\n                console.log(\"___savePromise\", node);\n                resolve(node);\n            });\n        });\n    }\n\n    _indexAction(req, res) {\n        return new Promise(function(resolve, reject) {\n            res.send(\"just /index action\");\n            resolve();\n        });\n    }\n\n    _testAction(req, res) {\n        var hello = new Node({\n            content: 'Hello, World!'\n        });\n\n        var savePromise = new Promise(function(resolve, reject) {\n            hello.save(function (err, node) {\n                if (err) reject(err);\n\n                console.log(\"___savePromise\", node.content);\n                resolve(node);\n            });\n        });\n\n        var findPromise = new Promise(function(resolve, reject) {\n            Node.find(function (err, nodes) {\n                if (err) reject(err);\n\n                console.log(\"___findPromise\", nodes);\n                resolve(nodes);\n            });\n\n            //Kitten.find({ name: /^Fluff/ }, callback);\n        });\n\n        return new Promise(function(resolve, reject) {\n            Promise.all([\n                savePromise,\n                findPromise\n            ]).then(function(results) {\n                resolve(results);\n            }).catch(function(err) {\n                reject();\n            });\n        });\n    }\n}\n\nmodule.exports = new Controller();\n"],"sourceRoot":"/source/"}